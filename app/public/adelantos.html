<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="imgs/icon.png" rel="icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <title>Car Wash - Adelantos</title>
</head>

<body
    style="height: 100vh; background: rgb(120,4,16);  background: linear-gradient(-20deg, rgba(120,4,16,1) 0%, rgba(15,15,15,1) 100%); background-attachment: fixed;">
    <div class="container-fluid  mt-1 px-5 ">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark rounded-3">
            <div class="container-fluid">
                <!-- <img src="/docs/5.0/assets/brand/bootstrap-logo.svg" alt="" width="30" height="24" class="d-inline-block align-text-top"> -->
                <a class="navbar-brand" href="/index"> Home</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link" href="/flujos-de-caja">Flujos de Caja</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/ordenes">Ordenes</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/requerimientos">Requerimientos</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle active" href="#" id="navbarDropdownMenuLink"
                                role="button" data-bs-toggle="dropdown" aria-expanded="false">Control de
                                trabajadores</a>
                            <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                                <li><a class="dropdown-item" href="/asistencias">Asistencias</a></li>
                                <li><a class="dropdown-item" href="/adelantos">Adelantos</a></li>
                                <li><a class="dropdown-item" href="/bonos">Bonos</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">Contactos</a>
                            <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                                <li><a class="dropdown-item" href="/clientes">Clientes</a></li>
                                <li><a class="dropdown-item" href="/proveedores">Proveedores</a></li>
                                <li><a class="dropdown-item" href="/trabajadores">Trabajadores</a></li>
                            </ul>
                        </li>
                        <li class="nav-item ">
                            <a class="nav-link" href="/servicios">Servicios</a>
                        </li>

                    </ul>
                </div>
            </div>
        </nav>
    </div>


    <div class="container-fluid col-11">
        <div class="container-fluid">
            <div class="row d-flex align-items-end my-3">
                <div class="col-md-auto">
                    <h1 style="margin-bottom: 0;" class="text-light"> Adelantos </h1>
                </div>

                <div class="col">
                    <a id="btn_create" class="btn btn-outline-light"> Crear </a>
                </div>
                <div class="col-md-auto">
                    <div class="d-flex align-items-center" style="margin-bottom: 0.5rem;">
                        <label class="text-white pe-2" for="desde">Desde:</label>
                        <input type="date" id="desde" name="desde">
                    </div>
                </div>
                <div class="col-md-auto">
                    <div class="d-flex align-items-center" style="margin-bottom: 0.5rem;">
                        <label class="text-white pe-2" for="hasta">Hasta:</label>
                        <input type="date" id="hasta" name="hasta">
                    </div>
                </div>
                <div class="col-md-auto">
                    <div class="d-flex align-items-center">
                        <label class="text-white pe-2 ">Trabajadores: </label>
                        <select id="select_trabajadores" class="form-select">


                        </select>
                    </div>
                </div>
            </div>
        </div>


        <table class="table table-bordered text-center table-dark table-striped">
            <thead>
                <tr>
                    <th scope="col" style="background-color: #921010;">Descripcion</th>
                    <th scope="col" style="background-color: #921010;">Cantidad Total</th>
                </tr>
            </thead>
            <tbody id="table_resumen">

            </tbody>
        </table>

        <table class="table table-bordered text-center table-dark table-striped">
            <thead>
                <tr>
                    <th scope="col" style="background-color: #921010;">Cantidad</th>
                    <th scope="col" style="background-color: #921010;">Descripcion</th>
                    <th scope="col" style="background-color: #921010;">Fecha</th>
                    <th scope="col" style="background-color: #921010;">Nombre</th>
                    <th scope="col" style="background-color: #921010;">Acciones</th>
                </tr>
            </thead>
            <tbody id="data_table">

            </tbody>
        </table>
    </div>

    <div id="modalCRUD" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel"></h5>
                </div>
                <form id="form_clientes">
                    <div class="modal-body">
                        <input id="codigo" hidden>
                        <!-- <input id="codigo_t" hidden> -->

                        <div id="display_flujo">
                            <label class="col-form-label my-2">Flujo de caja:</label>
                            <input type="checkbox" id="agregar_flujo" value="agregar_flujo" name="agregar_flujo"
                                checked>
                            <label for="agregar_flujo">Agregar</label> <br>
                        </div>

                        <label for="cantidad" class="col-form-label">Cantidad:</label>
                        <input type="number" class="form-control" id="cantidad" step=".01" required>

                        <label for="descripcion" class="col-form-label">Descripcion:</label>
                        <textarea rows="2" class="form-control" id="descripcion"></textarea>

                        <label for="fecha" class="col-form-label">Fecha:</label>
                        <input type="date" class="form-control" id="fecha">

                        <label for="select_trabajadores_form" class="col-form-label">Trabajadores:</label>
                        <select id="select_trabajadores_form" class="form-select">

                        </select>

                    </div>
                    <div class="modal-footer">
                        <button type="button" id="btn_cancel" class="btn btn-secondary"
                            data-dismiss="modal">Cancelar</button>
                        <button type="submit" id="btnGuardar" class="btn btn-dark">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script language="JavaScript" type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.23/dist/sweetalert2.all.min.js"></script>

    <script>
        let opcion = null;
        let codigo_t, codigo_c, descripcion, cantidad, fecha, hora, nombre;
        let total = 0.0;
        const workers = {};

        const desde = document.querySelector('#desde');
        const hasta = document.querySelector('#hasta');
        const d = new Date();
        let v_desde = "";
        let v_hasta = "";
        let dia = d.getDate();
        let mes = d.getMonth() + 1;
        let anio = d.getFullYear();
        if (mes < 10)
            v_hasta = anio + '-0' + mes;
        else
            v_hasta = anio + '-' + mes;

        if (dia < 10) {
            v_hasta += '-0' + dia;
            dia = '0' + dia;
        }
        else
            v_hasta += '-' + dia;

        if (dia == 31) {
            dia = 30;
        }
        if (dia >= 28 && mes == 3)
            dia = 28;

        if (mes <= 10)
            if (mes == 1)
                v_desde = (anio - 1) + '-12-' + dia;
            else
                v_desde = anio + '-0' + (mes - 1) + '-' + dia;
        else
            v_desde = anio + '-' + (mes - 1) + '-' + dia;

        desde.value = v_desde;
        hasta.value = v_hasta;

        load_trabajadores();
        load_data();
        setInterval(load_data, 2000);
        setInterval(load_trabajadores, 5000);

        //CREATE
        $("#btn_create").click(function () {
            opcion = 'crear';
            codigo_c = null;
            $("#form_clientes").trigger("reset");
            $("#placas_form").html("");
            $(".modal-header").css("background-color", "#23272b");
            $(".modal-header").css("color", "white");
            $(".modal-title").text("Agregar adelanto");
            $('#modalCRUD').modal('show');
            $("#display_flujo").css("display", "block");

            const d = new Date();
            let dia = d.getDate();
            let mes = d.getMonth() + 1;
            const anio = d.getFullYear();
            if (mes < 10)
                mes = '0' + mes;
            if (dia < 10)
                dia = '0' + dia;
            $('#fecha').val(anio + '-' + mes + '-' + dia);

            let hour = d.getHours();
            let minut = d.getMinutes();
            if (hour < 10)
                hour = '0' + hour;
            if (minut < 10)
                minut = '0' + minut;
            hora = hour + ':' + minut;
        });

        //EDIT
        $(document).ready(function () {
            $(document).on("click", ".btn_edit", function () {
                opcion = 'editar';
                $("#placas_form").html("");
                const row = $(this).closest("tr");
                codigo_c = parseInt(row.find('td:eq(0)').text());
                codigo_t = parseInt(row.find('td:eq(1)').text());
                cantidad = row.find('td:eq(2)').text().split('S/.')[1];
                descripcion = row.find('td:eq(3)').text();
                fecha = row.find('td:eq(4)').text();
                $("#codigo").val(codigo_c);
                $("#select_trabajadores_form").val(codigo_t);
                $("#cantidad").val(cantidad);
                $("#descripcion").val(descripcion);
                $("#fecha").val(fecha);
                $(".modal-header").css("background-color", "#23272b");
                $(".modal-header").css("color", "white");
                $(".modal-title").text("Editar adelanto");
                $("#display_flujo").css("display", "none");
                $('#modalCRUD').modal('show');
            });
        });

        //DELETE
        $(document).on("click", ".btn_delete", function () {
            codigo_c = $(this).closest('tr').find('td:eq(0)').text();
            Swal.fire({
                title: '¿Confirma eliminar el registro?',
                showCancelButton: true,
                confirmButtonText: `Confirmar`,
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/adelanto/' + codigo_c, { method: 'DELETE' })
                        .then(res => res.text());
                    load_data();
                    Swal.fire('¡Registro Eliminado!', '', 'success')
                }
            })
        });

        // boton CANCEL
        $("#btn_cancel").click(function () {
            $('#modalCRUD').modal('hide');
        });

        // form submit
        $('#form_clientes').submit(function (e) {
            e.preventDefault();
            codigo_c = $.trim($('#codigo').val());
            codigo_t = $.trim($('#select_trabajadores_form').val());
            cantidad = $.trim($('#cantidad').val());
            descripcion = $.trim($('#descripcion').val());
            fecha = $.trim($('#fecha').val());

            if (cantidad.length == 0) {
                alert('El [cantidad] es obligatorio');
                return;
            };

            if (opcion == 'crear') {
                fetch('/adelanto', {
                    method: 'POST',
                    headers: { 'Content-type': 'application/json' },
                    body: JSON.stringify({ cantidad, descripcion, fecha, codigo_t })
                })
                    .then(res => res.text())
                    .then(data => {
                        Swal.fire('¡Registro Agregado!', '', 'success')
                        load_data();
                    });
                if (document.querySelector('#agregar_flujo').checked) {
                    descripcion = "ADELANTO - " + descripcion + ' a ' + $.trim($('#select_trabajadores_form  option:selected').text());
                    fetch('/flujo_de_caja', {
                        method: 'POST',
                        headers: { 'Content-type': 'application/json' },
                        body: JSON.stringify({ descripcion, 'valor': -cantidad, tipo_pago:'1', hora, fecha })
                    })
                        .then(res => res.text());
                }
            }
            if (opcion == 'editar') {
                // Change data from cliente
                fetch('/adelanto/' + codigo_c, {
                    method: 'PUT',
                    headers: { 'Content-type': 'application/json' },
                    body: JSON.stringify({ cantidad, descripcion, fecha, codigo_t })
                })
                    .then(res => res.text())
                    .then(data => {
                        Swal.fire('¡Registro Modificado!', '', 'success')
                        load_data();
                    });
            }
            $('#modalCRUD').modal('hide');
        });


        // const input_search = document.querySelector('#inputtosearch');
        // input_search.addEventListener('keyup', (event) => {
        //     load_data();
        // });
        const btn_trabajadores = document.querySelector('#select_trabajadores');
        btn_trabajadores.addEventListener('change', (event) => {
            load_data();
        });

        // desde.value= d.getFullYear() + '-' + d.getMonth() + '-' + d.getDate();
        desde.addEventListener('change', (event) => {
            load_data();
        });
        hasta.addEventListener('change', (event) => {
            load_data();
        });

        function load_resumen() {
            const l_desde = document.querySelector('#desde').value;
            const l_hasta = document.querySelector('#hasta').value;
            const v_trabajador = document.querySelector('#select_trabajadores');
            let descrip;
            if (v_trabajador.value != '0') {
                descrip = "Total de adelantos de " + workers[v_trabajador.value] + " desde " + l_desde + " hasta " + l_hasta;
            }
            else
                descrip = "Total de adelantos de Todos desde " + l_desde + " hasta " + l_hasta;
            const table_resumen = document.querySelector('#table_resumen');
            let html = `<tr> <td>${descrip}</td>`
            html += `<td>S/.${Number(total).toFixed(2)}</td></tr>`;
            table_resumen.innerHTML = html;
        }

        function load_data() {
            // const v_search = document.querySelector('#inputtosearch').value;
            const l_desde = document.querySelector('#desde').value;
            const l_hasta = document.querySelector('#hasta').value;
            const v_trabajador = document.querySelector('#select_trabajadores').value;
            let url = '/adelanto/' + l_desde + '/' + l_hasta + '/';
            if (v_trabajador != '0')
                url += v_trabajador;
            fetch(url, { method: 'GET' })
                .then(res => res.json())
                .then(data => {
                    total = 0.0;
                    const data_table = document.querySelector('#data_table');
                    let html = '';
                    data.forEach(element => {
                        html += `<tr> <td hidden> ${element.codigo} </td>`;
                        html += `<td hidden> ${element.codigo_trabajador} </td>`;
                        html += `<td>S/.${Number(element.cantidad).toFixed(2)}</td>`;
                        html += `<td>${element.descripcion}</td>`;
                        html += `<td>${element.fecha.substr(0, 10)}</td>`;
                        html += `<td>${element.trabajador}</td>`;
                        html += `<td><a href='#'' class='btn btn-outline-light btn_edit'>editar</a> <a href='#'' class='btn btn-outline-danger btn_delete'>borrar</a></td></tr>`;
                        total += element.cantidad;
                    });
                    data_table.innerHTML = html;
                    load_resumen();
                });
        }



        function load_trabajadores() {

            fetch('/trabajador/1', { method: 'GET' })
                .then(res => res.json())
                .then(data => {
                    const data_table = document.querySelector('#select_trabajadores');
                    const select_trabajadores_form = document.querySelector('#select_trabajadores_form');
                    let html = "<option value='0' selected>Todos</option>";
                    let html2 = "";
                    data.forEach(element => {
                        html += `<option value="${element.codigo}">`
                        html2 += `<option value="${element.codigo}">`
                        html += `${element.name.split(" ")[0]} ${element.name.split(" ")[2]}</option>`;
                        html2 += `${element.name.split(" ")[0]} ${element.name.split(" ")[2]}</option>`;
                        workers[element.codigo] = element.name.split(" ")[0] + ' ' + element.name.split(" ")[2];
                    });
                    data_table.innerHTML = html;
                    select_trabajadores_form.innerHTML = html2;
                });
        }
    </script>
</body>

</html>